---
import { formatDate } from "@packages/utils/date";
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import Responsive from "@packages/ui/Responsive.astro";
import SuperTitle from "@packages/ui/SuperTitle.astro";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  const tags = [...new Set(posts.flatMap((el) => el.data.tags))].filter(
    (t) => !!t,
  );

  return tags.map((t) => {
    return {
      params: { tag: t },
      props: {
        tag: t,
        posts: posts.filter((el) => (el.data.tags ?? []).includes(t)),
      },
    };
  });
}

const { tag, posts } = Astro.props;

let sortedPosts = posts.sort(
  (a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf(),
);
---

<Layout>
  <nav>
    <SuperTitle title={`Posts tagged with "${tag}"`} />
    <Responsive>
      {
        sortedPosts.map(({ data: { description, title, slug, date } }) => (
          <div class="post">
            <a href={`/${slug}`}>{title}</a>
            <time datetime={date}>{formatDate(date)}</time>
            <span>{description}</span>
          </div>
        ))
      }
    </Responsive>
  </nav>
</Layout>

<style>
  .post {
    display: flex;
    flex-direction: column;
    margin-block: var(--babase);
  }
</style>
